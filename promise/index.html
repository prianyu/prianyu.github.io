<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promise的原理与实现 | 深海鱼的博客</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?6d4a5d87b33ca87294c3a9acdd184d30";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();   
    </script>
    <meta name="description" content="web前端技术博客,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,React,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.2e3f2297.css" as="style"><link rel="preload" href="/assets/js/app.7229fa99.js" as="script"><link rel="preload" href="/assets/js/2.240321f5.js" as="script"><link rel="preload" href="/assets/js/48.232fa4df.js" as="script"><link rel="prefetch" href="/assets/js/10.1f205a2c.js"><link rel="prefetch" href="/assets/js/11.efc3205c.js"><link rel="prefetch" href="/assets/js/12.f26d4ccd.js"><link rel="prefetch" href="/assets/js/13.432134d6.js"><link rel="prefetch" href="/assets/js/14.c39a5562.js"><link rel="prefetch" href="/assets/js/15.6598a095.js"><link rel="prefetch" href="/assets/js/16.5f84550a.js"><link rel="prefetch" href="/assets/js/17.bc56c96d.js"><link rel="prefetch" href="/assets/js/18.6b7a78cf.js"><link rel="prefetch" href="/assets/js/19.9d64722f.js"><link rel="prefetch" href="/assets/js/20.7a5758ab.js"><link rel="prefetch" href="/assets/js/21.026cc2c2.js"><link rel="prefetch" href="/assets/js/22.aa884b14.js"><link rel="prefetch" href="/assets/js/23.fc913c73.js"><link rel="prefetch" href="/assets/js/24.def69170.js"><link rel="prefetch" href="/assets/js/25.25b9c791.js"><link rel="prefetch" href="/assets/js/26.7a58b783.js"><link rel="prefetch" href="/assets/js/27.022ea7ee.js"><link rel="prefetch" href="/assets/js/28.0f845be0.js"><link rel="prefetch" href="/assets/js/29.80c3cd53.js"><link rel="prefetch" href="/assets/js/3.b4328612.js"><link rel="prefetch" href="/assets/js/30.e92d209d.js"><link rel="prefetch" href="/assets/js/31.b1c625b6.js"><link rel="prefetch" href="/assets/js/32.46337a85.js"><link rel="prefetch" href="/assets/js/33.88c66996.js"><link rel="prefetch" href="/assets/js/34.b6c7a9b4.js"><link rel="prefetch" href="/assets/js/35.e4144dd8.js"><link rel="prefetch" href="/assets/js/36.7e788485.js"><link rel="prefetch" href="/assets/js/37.ba5cbc05.js"><link rel="prefetch" href="/assets/js/38.7993f788.js"><link rel="prefetch" href="/assets/js/39.8ca92140.js"><link rel="prefetch" href="/assets/js/4.92350222.js"><link rel="prefetch" href="/assets/js/40.d2880853.js"><link rel="prefetch" href="/assets/js/41.fbcd433c.js"><link rel="prefetch" href="/assets/js/42.ce11d19b.js"><link rel="prefetch" href="/assets/js/43.17f06add.js"><link rel="prefetch" href="/assets/js/44.3feef585.js"><link rel="prefetch" href="/assets/js/45.9015eaec.js"><link rel="prefetch" href="/assets/js/46.d9f53a49.js"><link rel="prefetch" href="/assets/js/47.e69e3cc6.js"><link rel="prefetch" href="/assets/js/49.70fe9349.js"><link rel="prefetch" href="/assets/js/5.2b79f9cd.js"><link rel="prefetch" href="/assets/js/50.c924a321.js"><link rel="prefetch" href="/assets/js/51.f0cfd1e9.js"><link rel="prefetch" href="/assets/js/52.e5ab2ad4.js"><link rel="prefetch" href="/assets/js/53.c346ac5d.js"><link rel="prefetch" href="/assets/js/54.87be6e82.js"><link rel="prefetch" href="/assets/js/55.9c84fec7.js"><link rel="prefetch" href="/assets/js/56.ee50f9a5.js"><link rel="prefetch" href="/assets/js/57.7592b7db.js"><link rel="prefetch" href="/assets/js/58.cd474215.js"><link rel="prefetch" href="/assets/js/59.4dfe03c6.js"><link rel="prefetch" href="/assets/js/6.2bba114d.js"><link rel="prefetch" href="/assets/js/60.f12a32cd.js"><link rel="prefetch" href="/assets/js/61.4abc19d7.js"><link rel="prefetch" href="/assets/js/62.5f992451.js"><link rel="prefetch" href="/assets/js/63.ed1805c6.js"><link rel="prefetch" href="/assets/js/64.acd68153.js"><link rel="prefetch" href="/assets/js/65.64a9bdaf.js"><link rel="prefetch" href="/assets/js/66.45b9f3f6.js"><link rel="prefetch" href="/assets/js/67.24e0a963.js"><link rel="prefetch" href="/assets/js/68.ef0c6c53.js"><link rel="prefetch" href="/assets/js/69.8a34ab70.js"><link rel="prefetch" href="/assets/js/7.c3bb136b.js"><link rel="prefetch" href="/assets/js/8.c79d42ff.js"><link rel="prefetch" href="/assets/js/9.57a0a5d3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2e3f2297.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/avatar.jpg" alt="深海鱼的博客" class="logo"> <span class="site-name can-hide">深海鱼的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><a href="/foundation/" class="link-title">基础</a> <span class="title" style="display:none;">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f344d070a1031ef7/" class="nav-link">《ES6 教程》</a></li><li class="dropdown-item"><!----> <a href="/pages/51afd6/" class="nav-link">《TypeScript》</a></li><li class="dropdown-item"><!----> <a href="/note/vue/" class="nav-link">《Vue》</a></li><li class="dropdown-item"><!----> <a href="/note/react/" class="nav-link">《React》</a></li><li class="dropdown-item"><!----> <a href="/note/git/" class="nav-link">《Git》</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><a href="/advanced/" class="link-title">进阶</a> <span class="title" style="display:none;">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">Javascript</a></li><li class="dropdown-item"><!----> <a href="/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><a href="/implements/" class="nav-link">手写系列</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目实战" class="dropdown-title"><a href="/practices/" class="link-title">项目实战</a> <span class="title" style="display:none;">项目实战</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f97bc1/" class="nav-link">React项目实战</a></li><li class="dropdown-item"><!----> <a href="/pages/f97bc1/" class="nav-link">Vue3项目实战</a></li><li class="dropdown-item"><!----> <a href="/pages/f97bc1/" class="nav-link">服务端项目实战</a></li><li class="dropdown-item"><!----> <a href="/pages/f97bc1/" class="nav-link">鸿蒙项目实战</a></li><li class="dropdown-item"><!----> <a href="/pages/4c042c/" class="nav-link">小小实践</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="源码解读" class="dropdown-title"><a href="/pages/405b1d/" class="link-title">源码解读</a> <span class="title" style="display:none;">源码解读</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Vue全家桶</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/92d020/" class="nav-link">Vue2.0</a></li><li class="dropdown-subitem"><a href="/pages/c01a6e/" class="nav-link">Vue3.0</a></li><li class="dropdown-subitem"><a href="/pages/a60a54/" class="nav-link">VueRouter</a></li><li class="dropdown-subitem"><a href="/pages/09f5da/" class="nav-link">Vuex</a></li></ul></li><li class="dropdown-item"><h4>React</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/e7c037/" class="nav-link">React</a></li></ul></li><li class="dropdown-item"><!----> <a href="/pages/e0a820/" class="nav-link">Axios</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/prianyu/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/img/avatar.jpg"> <div class="blogger-info"><h3>深海鱼</h3> <span>尽人事，知天命，知行合一。</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><a href="/foundation/" class="link-title">基础</a> <span class="title" style="display:none;">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f344d070a1031ef7/" class="nav-link">《ES6 教程》</a></li><li class="dropdown-item"><!----> <a href="/pages/51afd6/" class="nav-link">《TypeScript》</a></li><li class="dropdown-item"><!----> <a href="/note/vue/" class="nav-link">《Vue》</a></li><li class="dropdown-item"><!----> <a href="/note/react/" class="nav-link">《React》</a></li><li class="dropdown-item"><!----> <a href="/note/git/" class="nav-link">《Git》</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="进阶" class="dropdown-title"><a href="/advanced/" class="link-title">进阶</a> <span class="title" style="display:none;">进阶</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/8309a5b876fc95e3/" class="nav-link">Javascript</a></li><li class="dropdown-item"><!----> <a href="/pages/0a83b083bdf257cb/" class="nav-link">CSS</a></li></ul></div></div><div class="nav-item"><a href="/implements/" class="nav-link">手写系列</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="项目实战" class="dropdown-title"><a href="/practices/" class="link-title">项目实战</a> <span class="title" style="display:none;">项目实战</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f97bc1/" class="nav-link">React项目实战</a></li><li class="dropdown-item"><!----> <a href="/pages/f97bc1/" class="nav-link">Vue3项目实战</a></li><li class="dropdown-item"><!----> <a href="/pages/f97bc1/" class="nav-link">服务端项目实战</a></li><li class="dropdown-item"><!----> <a href="/pages/f97bc1/" class="nav-link">鸿蒙项目实战</a></li><li class="dropdown-item"><!----> <a href="/pages/4c042c/" class="nav-link">小小实践</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="源码解读" class="dropdown-title"><a href="/pages/405b1d/" class="link-title">源码解读</a> <span class="title" style="display:none;">源码解读</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Vue全家桶</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/92d020/" class="nav-link">Vue2.0</a></li><li class="dropdown-subitem"><a href="/pages/c01a6e/" class="nav-link">Vue3.0</a></li><li class="dropdown-subitem"><a href="/pages/a60a54/" class="nav-link">VueRouter</a></li><li class="dropdown-subitem"><a href="/pages/09f5da/" class="nav-link">Vuex</a></li></ul></li><li class="dropdown-item"><h4>React</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/e7c037/" class="nav-link">React</a></li></ul></li><li class="dropdown-item"><!----> <a href="/pages/e0a820/" class="nav-link">Axios</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/prianyu/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/new-instanceof/" class="sidebar-link">new与instanceof的实现</a></li><li><a href="/b call-apply-bind/" class="sidebar-link">call、apply和bind实现</a></li><li><a href="/promise/" aria-current="page" class="active sidebar-link">Promise的原理与实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/promise/#一、promise的特点" class="sidebar-link">一、Promise的特点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/promise/#状态与状态流转" class="sidebar-link">状态与状态流转</a></li><li class="sidebar-sub-header level3"><a href="/promise/#链式调用" class="sidebar-link">链式调用</a></li><li class="sidebar-sub-header level3"><a href="/promise/#es6中promise的组成部分" class="sidebar-link">ES6中Promise的组成部分</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/promise/#二、promise的基本使用" class="sidebar-link">二、Promise的基本使用</a></li><li class="sidebar-sub-header level2"><a href="/promise/#三、promise的规范" class="sidebar-link">三、Promise的规范</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/promise/#_1-相关术语" class="sidebar-link">1. 相关术语</a></li><li class="sidebar-sub-header level3"><a href="/promise/#_2-要求" class="sidebar-link">2. 要求</a></li><li class="sidebar-sub-header level4"><a href="/promise/#_2-1-promise的状态" class="sidebar-link">2.1 Promise的状态</a></li><li class="sidebar-sub-header level4"><a href="/promise/#_2-2-then方法" class="sidebar-link">2.2 then方法</a></li><li class="sidebar-sub-header level4"><a href="/promise/#_2-3-promise解析过程" class="sidebar-link">2.3 Promise解析过程</a></li><li class="sidebar-sub-header level3"><a href="/promise/#_3-规范解释" class="sidebar-link">3. 规范解释</a></li><li class="sidebar-sub-header level3"><a href="/promise/#_4-ecmcscript中的promise规范" class="sidebar-link">4. ECMCScript中的Promise规范</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/promise/#四、promise的实现" class="sidebar-link">四、Promise的实现</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/promise/#_1-声明promise类" class="sidebar-link">1. 声明Promise类</a></li><li class="sidebar-sub-header level3"><a href="/promise/#_2-构造函数constructor-executor" class="sidebar-link">2. 构造函数constructor(executor)</a></li><li class="sidebar-sub-header level3"><a href="/promise/#_3-resolve和reject函数" class="sidebar-link">3. resolve和reject函数</a></li><li class="sidebar-sub-header level3"><a href="/promise/#_4-then实例方法" class="sidebar-link">4. then实例方法</a></li><li class="sidebar-sub-header level3"><a href="/promise/#_5-resolvepromise" class="sidebar-link">5. resolvePromise</a></li><li class="sidebar-sub-header level3"><a href="/promise/#_6-runtask辅助函数" class="sidebar-link">6. runTask辅助函数</a></li><li class="sidebar-sub-header level3"><a href="/promise/#_7-catch与finally实例方法" class="sidebar-link">7. catch与finally实例方法</a></li><li class="sidebar-sub-header level3"><a href="/promise/#_8-各种静态方法" class="sidebar-link">8. 各种静态方法</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/promise/#五、测试" class="sidebar-link">五、测试</a></li></ul></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-057748f7><div class="articleInfo" data-v-057748f7><ul class="breadcrumbs" data-v-057748f7><li data-v-057748f7><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-057748f7></a></li> <li data-v-057748f7><a href="/implements/#手写系列" data-v-057748f7>手写系列</a></li></ul> <div class="info" data-v-057748f7><div title="作者" class="author iconfont icon-touxiang" data-v-057748f7><a href="https://github.com/prianyu" target="_blank" title="作者" class="beLink" data-v-057748f7>深海鱼</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-057748f7><a href="javascript:;" data-v-057748f7>2024-06-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">Promise的原理与实现<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="promise的原理与实现"><a href="#promise的原理与实现" class="header-anchor">#</a> Promise的原理与实现</h1> <p><code>Promise</code>是异步编程的一种解决方案，它比传统的解决方案“回调函数和事件”更合理和更强大。<code>Promise</code>由社区最早提出和实现，ES6 将其写进了语言标准，统一了用法，原生提供了<code>Promise</code>对象。</p> <p>一个<code>Promise</code>是一个代理，它代表一个在创建<em>promise</em>时不一定已知的值。它允许你将处理程序与异步操作的最终成功值或失败原因关联起来。这使得异步方法可以像同步方法一样返回值：异步方法不会立即返回最终值，而是返回一个<em>promise</em>，以便在将来的某个时间点提供该值。</p> <h2 id="一、promise的特点"><a href="#一、promise的特点" class="header-anchor">#</a> 一、Promise的特点</h2> <h3 id="状态与状态流转"><a href="#状态与状态流转" class="header-anchor">#</a> 状态与状态流转</h3> <ol><li><code>Promise</code>有三种状态：<code>pending</code>、<code>fulfilled</code>、<code>rejected</code>。
<ul><li><code>pending</code>：初始状态，既没有被兑现，也没有被拒绝。</li> <li><code>fulfilled</code>：意味着操作成功完成。</li> <li><code>rejected</code>：意味着操作失败。</li></ul></li> <li><code>Promise</code>只能从<code>pending</code>状态变为<code>fulfilled</code>或<code>rejected</code>状态。</li> <li><code>Promise</code>的状态一旦改变，就不会再变。</li></ol> <h3 id="链式调用"><a href="#链式调用" class="header-anchor">#</a> 链式调用</h3> <p>连续执行两个或者多个异步操作是一个常见的需求，在上一个操作执行成功之后，开始下一个的操作，并带着上一步操作所返回的结果。在传统的回调风格中，这种操作会导致经典的<a href="http://callbackhell.com/" target="_blank" rel="noopener noreferrer">回调地狱问题<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。<code>Promise</code>通过一个<code>Promise链</code>来解决这个问题，这也是Promise API 的核心优势。</p> <ol><li><code>Promise</code>对象具有<code>then</code>方法，<code>then</code>方法接收两个参数：<code>onFulfilled</code>和<code>onRejected</code>。</li> <li><code>then</code>方法返回一个新的<code>Promise</code>对象，所以支持链式调用。</li></ol> <h3 id="es6中promise的组成部分"><a href="#es6中promise的组成部分" class="header-anchor">#</a> ES6中Promise的组成部分</h3> <p>在ES6的标准中，<code>Promise</code>包含以下几个主要的部分：</p> <ul><li><code>Promise</code>构造函数</li> <li><code>Promise</code>静态方法和静态属性</li> <li><code>Promise</code>实例方法</li></ul> <p>其中构造函数与实例方法中的<code>then</code>方法是<strong>Promise规范</strong>的组成部分，也是最主要的的部分，其它的静态方法和静态属性等是<code>Promise</code>的辅助工具。</p> <h2 id="二、promise的基本使用"><a href="#二、promise的基本使用" class="header-anchor">#</a> 二、Promise的基本使用</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'错误1'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;错误2&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 输出：</span>
<span class="token string">&quot;succes&quot;</span>
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token string">&quot;错误2 Error: error&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h2 id="三、promise的规范"><a href="#三、promise的规范" class="header-anchor">#</a> 三、Promise的规范</h2> <p>我们现在谈的<code>Promise规范</code>通常指<a href="https://promisesaplus.com/" target="_blank" rel="noopener noreferrer">Promise/A+规范<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。主要内容如下：</p> <h3 id="_1-相关术语"><a href="#_1-相关术语" class="header-anchor">#</a> 1. 相关术语</h3> <ul><li><code>Promise</code>：是一个具有<code>then</code>方法的符合本规范的对象或函数</li> <li><code>thenable</code>：是一个具有<code>then</code>方法的对象或函数</li> <li><code>value</code>：一个合法的Javascript值</li> <li><code>exception</code>：通过<code>throw</code>声明的一个异常值</li> <li><code>reason</code>：一个合法的Javascript值，用于拒绝<code>Promise</code>的原因</li></ul> <h3 id="_2-要求"><a href="#_2-要求" class="header-anchor">#</a> 2. 要求</h3> <p>规范对<code>Promise</code>的状态、<code>then</code>方法的要求以及<code>Promise</code>的解析过程都做了要求，这也是<code>Promise</code>规范中最核心的部分。</p> <h4 id="_2-1-promise的状态"><a href="#_2-1-promise的状态" class="header-anchor">#</a> 2.1 Promise的状态</h4> <p>一个promise的状态必须是<code>pending</code>，<code>fulfilled</code>和 <code>rejected</code>中的一个。</p> <ol><li>当处于<code>pending</code>状态时，可以改变状态为<code>fulfilled</code>，或者改变状态为<code>rejected</code>。</li> <li>当处于<code>fulfilled</code>状态时，不能改变为任何状态，且必须有个不可被改变的<code>value</code>。</li> <li>当处于<code>rejected</code>状态时，不能改变为任何状态，且必须有个不可被改变的<code>reason</code>。</li></ol> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>此处说的“<strong>不可改变</strong>”，只是其引用不可变，但如果值本身是个对象，它的内容是可能被改变的。即不保证深度不可变。</p></div> <h4 id="_2-2-then方法"><a href="#_2-2-then方法" class="header-anchor">#</a> 2.2 then方法</h4> <p>一个promise必须提供一个<code>then</code>方法，用于处理其<code>value</code>和<code>reason</code>。该方法接受两个参数：<code>onFulfilled</code>和<code>onRejected</code>。</p> <p><strong>对于<code>promise.then(onFulfilled, onRejected)</code>：</strong></p> <ol><li><code>onFulfilled</code>和<code>onRejected</code>都是可选参数。
<ul><li>如果<code>onFulfilled</code>不是一个函数，则<code>onFulfilled</code>必须被忽略。</li> <li>如果<code>onRejected</code>不是一个函数，则<code>onRejected</code>必须被忽略。</li></ul></li> <li>如果<code>onFulfilled</code>是一个函数，则：
<ul><li>它必须在<code>promise</code>状态变为<code>fulfilled</code>时调用，并接收<code>value</code>作为第一个参数。</li> <li>在变为<code>fulfilled</code>之前不能被调用</li> <li>只能被调用一次</li></ul></li> <li>如果<code>onRejected</code>是一个函数，则：
<ul><li>它必须在<code>promise</code>状态变为<code>rejected</code>时调用，并接收<code>reason</code>作为第一个参数。</li> <li>在变为<code>rejected</code>之前不能被调用</li> <li>只能被调用一次</li></ul></li> <li>在执行上下文堆栈(<code>execution contetxt stack</code>)只包含平台代码（<code>platform code</code>）之前，不能调用<code>onFulfilled</code>或<code>onRejected</code>。</li> <li><code>onFulfilled</code>或<code>onRejected</code>必须被作为普通函数调用（比如没有<code>this</code>值）。</li> <li><code>then</code>可以在同一个promise上多次调用
<ul><li>当promise已经处于<code>fulfilled</code>或变为<code>fulfilled</code>状态时，所有的<code>onFulfilled</code>回调函数都会按顺序被调用。</li> <li>当promise已经处于<code>rejected</code>或变为<code>rejected</code>状态时，所有的<code>onRejected</code>回调函数都会按顺序被调用。</li></ul></li> <li><code>then</code>必须返回一个promise：<code>promise2 = promise1.then(onFulfilled, onRejected)</code> <ul><li>如果<code>onFulfilled</code>或者<code>onRejected</code>返回一个值<code>x</code>，则进入Promise的解析流程，调用<code>[[Resolve]](promise2, x)</code></li> <li>如果<code>onFulfilled</code>或者<code>onRejected</code>抛出一个异常<code>e</code>，则<code>promise2</code>必须被拒绝，并将<code>e</code>作为拒绝原因</li> <li>如果<code>onFulfilled</code>不是一个函数且<code>promise1</code>状态变为<code>fulfilled</code>，<code>promise2</code>必须被设置成<code>fulfilled</code>，并将<code>promise1</code>的值作为成功原因</li> <li>如果<code>onRejected</code>不是一个函数且<code>promise1</code>状态变为<code>rejected</code>，<code>promise2</code>必须被设置成<code>rejected</code>，并将<code>promise1</code>的拒绝原因作为<code>promise2</code>的拒绝原因</li></ul></li></ol> <h4 id="_2-3-promise解析过程"><a href="#_2-3-promise解析过程" class="header-anchor">#</a> 2.3 Promise解析过程</h4> <p><code>Promise</code>解析时接收一个<code>promise</code>和一个<code>x</code>作为参数，根据<code>x</code>的类型，执行不同的操作，并将这个过程记为<code>[[Resolve]](promise, x)</code>。如果<code>x</code>是一个<code>Thenable</code>对象，那么会在假设<code>x</code>的行为表现得像一个<code>Promise</code>的基础上，让<code>promise</code>采取<code>x</code>的状态。否则就使用<code>x</code>来兑现<code>promise</code>。</p> <p>这种对<code>thenable</code>的处理使得<code>Promise</code>的实现更具通用性：只要它们暴露了一个遵循**Promise/A+**规范的<code>then</code>方法，那么就它们之间就可以相互操作。同时也使得<code>Promise</code>的实现可以与那些不太符合规范的实现能够良好的共存。</p> <p><strong>运行<code>[[Resolve]](promise2, x)</code>，需要经过以下步骤：</strong></p> <blockquote><p>为了与前面的<code>then</code>方法呼应上，这里将<code>promise</code>记为<code>promise2</code></p></blockquote> <ol><li>如果<code>promise2</code>和<code>x</code>是同一个对象，则<code>promise2</code>必须被拒绝，并抛出一个<code>TypeError</code>作为拒绝原因。</li> <li>如果<code>x</code>是一个<code>Promise</code>，则<code>promise2</code>采用<code>x</code>的状态：
<ol><li>如果<code>x</code>处于<code>pending</code>状态，<code>promise2</code>必须保持<code>pending</code>状态，直到<code>x</code>被兑现或拒绝。</li> <li>如果<code>x</code>处于<code>fulfilled</code>状态，则<code>promise2</code>必须被兑现，并采用<code>x</code>相同的终值。</li> <li>如果<code>x</code>处于<code>rejected</code>状态，则<code>promise2</code>必须被拒绝，并采用相同的拒绝原因。</li></ol></li> <li>否则，如果<code>x</code>是一个对象或者函数：
<ol><li>令<code>then</code>等于<code>x.then</code></li> <li>如果<code>x.then</code>取值抛出了异常<code>e</code>，则以<code>e</code>作为原因拒绝<code>promise2</code></li> <li>如果<code>then</code>是一个函数，则将<code>x</code>作为<code>this</code>执行<code>then</code>，并传入两个参数：第一个参数是<code>resolvePromise</code>，第二个参数是<code>rejectPromise</code>。</li> <li>当<code>resolvePromise</code>接收一个参数<code>y</code>被调用时，执行<code>[[Resolve]](promise2, y)</code></li> <li>当<code>rejectPromise</code>接收一个参数<code>r</code>被调用时，以<code>r</code>作为原因拒绝<code>promise2</code></li> <li><code>resolvePromise</code>和<code>rejectPromise</code>只能被调用一次</li> <li>如果<code>then</code>执行抛出一个异常<code>e</code>，<code>promise2</code>以<code>e</code>拒绝：如果 <code>resolvePromise</code>或<code>rejectPromise</code>已经执行过了，则忽略这个异常，否则以<code>e</code>拒绝<code>promise2</code></li> <li>否则，<code>then</code>不是一个函数，则<code>promise2</code>以<code>x</code>为值解决</li></ol></li> <li>否则，<code>promise2</code>以<code>x</code>为值解决</li></ol> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>如果一个<code>promise</code>被一个循环的<code>thenable</code>链中的对象解决，而<code>[[Resolve]](promise, x)</code>的递归性质又使得其被再次调用，根据上述的算法，这个<code>promise</code>将陷入无限的递归当中并永远处于<code>pending</code>状态。算法虽然不强制要求处理这种情况，但是鼓励实现者检测这样的递归是否存在，若检测到，则 抛出一个<code>TypeError</code>拒绝这个<code>promise</code>。</p> <details class="custom-block details"><summary>示例</summary> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> thenable <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">then</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onFulfilled</span><span class="token punctuation">(</span>thenable<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>thenable<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token parameter">res</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></details></div> <h3 id="_3-规范解释"><a href="#_3-规范解释" class="header-anchor">#</a> 3. 规范解释</h3> <ul><li>规范中所说的<code>“平台代码”</code>指的是引擎、环境以及Promise的实现代码。在实践中要保证<code>onFulfilled</code>和<code>onRejected</code>函数是异步执行的，并且是在<code>then</code>方法被调用后的新一轮事件循环中的新执行栈中执行。这个机制可以采用“宏任务（Macro Task）”的机制来实现，比如<code>setTimeout</code>或<code>setImmediate</code>；也可以使用“微任务（Micro Task）”的机制来实现，如<code>MutationObserver</code>或<code>process.nextTick</code>。由于Promise的实现被认为是平台代码的一部分，它可能自身就包含了一个任务调度队列或者<code>trampoline</code>（一种递归到尾调用的优化技术）。</li> <li><code>onFulfilled</code>或<code>onRejected</code>必须被作为普通函数调用，在严格模式中，其this为undefined，否则为全局对象</li> <li>在处理<code>thenable</code>时，令<code>then=x.then</code>并测试该引用，这种方式可以避免多次访问<code>x.then</code>，确保属性的一致性，因为其值可能在检索调用时发生了改变。</li></ul> <h3 id="_4-ecmcscript中的promise规范"><a href="#_4-ecmcscript中的promise规范" class="header-anchor">#</a> 4. ECMCScript中的Promise规范</h3> <p>从以上的规范来看，Promise/A+ 规范并没有提及我们平时使用<code>Promise</code>时使用到的<strong>构造函数、reject函数、resolve函数</strong>以及各种静态方法的具体定义和实现方式（但是指明了它们之间是同步还是异步执行的要求）。这是因为Promises/A+规范的思想并不是提供某种库API。它是为了提供一组最小的可互操作的原语，以便任何使用<code>Promise</code>的人都可以依赖于它具有统一的接口。这对于跨库互操作尤其重要，例如在应用程序的不同组件的接缝处，可能在内部使用不同的<code>Promise</code>库。为<code>Promise</code>库指定完整的API并不是实现这一目标的必要条件。</p> <p>然而ECMAScript6中，新增了<code>Promise</code>对象是对Promise/A+规范的一种具体实现。它对<code>Promise</code>实现的要求提出更加严格的要求，已经超出了<code>Promise/A+</code>规范。换句话说，ECMAScript的<code>Promise</code>对象只是众多``Promise/A+`规范实现的一种，你自己的实现则不一定非要严格遵循ECMAScript的Promise规范。</p> <p><a href="https://tc39.es/ecma262/multipage/control-abstraction-objects.html#sec-promise-objects" target="_blank" rel="noopener noreferrer">ECMAScript@2025 Language Specification#Promise-Object<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>以下为ECMAScript的Promise规范对<code>reject函数</code>、<code>resolve函数</code>以及<code>constructor</code>函数的定义：</p> <p><strong><code>resolve(resolution)</code>：</strong></p> <ol><li>令<code>F</code>为激活的函数对象</li> <li>确保<code>F</code>是一个具有<code>[[Promise]]</code>属性（内部槽）的对象</li> <li>令<code>promise</code>为<code>F</code>.[[Promise]]属性的值</li> <li>令<code>alreadyResolved</code>为F.[[AlreadyResolved]]属性的值</li> <li>如果<code>alreadyResolved</code>.[[Value]]为true，<code>return undefined</code></li> <li>令<code>alreadyResolved</code>.[[Value]]为true</li> <li>如果<code>resolution</code>为<code>promise</code>，<code>throw a TypeError</code></li> <li>如果<code>resolution</code>为不是一个对象，则执行<code>FulfillPromise(promise, resolution)</code>，并<code>return undefined</code></li> <li>否则令<code>then</code>为<code>resolution.then</code>（处理thenable，处理步骤与上文<code>promise.then</code>基本一致）</li> <li><code>return undefined</code></li></ol> <p><strong><code>reject(reason)</code>：</strong></p> <ol><li>令<code>F</code>为激活的函数对象</li> <li>确保<code>F</code>是一个具有<code>[[Promise]]</code>属性（内部槽）的对象</li> <li>令<code>promise</code>为<code>F</code>.[[Promise]]属性的值</li> <li>令<code>alreadyResolved</code>为F.[[AlreadyResolved]]属性的值</li> <li>如果<code>alreadyResolved</code>.[[Value]]为true，<code>return undefined</code></li> <li>令<code>alreadyResolved</code>.[[Value]]为true</li> <li>执行<code>RejectPromise(promise, reason)</code></li> <li><code>return undefined</code></li></ol> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>ECMAScript中，<code>reject</code>和<code>resolve</code>都是内置的匿名函数，它们含有<code>[[Promise]]</code>、<code>[[AlreadyResolved]]</code>等属性，是<code>Promise</code>对象的内部槽。</p></div> <p><strong><code>constructor(executor)</code>：</strong></p> <ol><li>如果NewTarget是<code>undefined</code>，抛出一个<code>TypeError</code>异常。</li> <li>如果<code>executor</code>不可调用，抛出一个<code>TypeError</code>异常。`</li> <li>创建<code>promise</code>对象，且原型为<code>Promise.prototype</code>，定义<code>[[PromiseState]]</code>、<code>[[PromiseResult]]</code>、<code>[[PromiseFulfillReactions]]</code>、<code>[[PromiseRejectReactions]]</code>、<code>[[PromiseIsHandled]]</code>。</li> <li>设置<code>[[PromiseState]]</code>为<code>pending</code>。</li> <li>设置<code>[[PromiseFulfillReactions]]</code>为空数组。</li> <li>设置<code>[[PromiseRejectReactions]]</code>为空数组。</li> <li>设置<code>[[PromiseIsHandled]]</code>为<code>false</code>。</li> <li>创建<code>resolvingFunctions</code>，即用于改变状态的<code>resolve</code>和<code>reject</code>函数。</li> <li>调用<code>executor</code>函数，并传入<code>resolve</code>和<code>reject</code>函数作为参数。结果为<code>completion</code></li> <li>如果<code>completion</code>是异常值，则调用<code>reject</code>函数，并传入<code>completion</code>作为参数。</li> <li>返回<code>promise</code>。</li></ol> <h2 id="四、promise的实现"><a href="#四、promise的实现" class="header-anchor">#</a> 四、Promise的实现</h2> <p>如上文所说<code>Promise/A+</code>规范一种解决思想，不是具体的实现。在社区中有非常多的实现，除了<strong>Javascript</strong>的各种具体实现方式，还包括<strong>Java、Python、PHP、Swift、Objective-C</strong>等等。可以点击这里查看<a href="https://promisesaplus.com/implementations" target="_blank" rel="noopener noreferrer">Conformant Implementations<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>下面，我们将一步步的实现<code>Promise/A+</code>规范以及<code>ECMAScript Promise规范</code>中的一些静态方法。</p> <h3 id="_1-声明promise类"><a href="#_1-声明promise类" class="header-anchor">#</a> 1. 声明Promise类</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
  <span class="token comment">// 构造函数</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token comment">// resolve函数</span>
    <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token comment">// reject函数</span>
  <span class="token punctuation">}</span> 

  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token comment">// then方法</span>
  <span class="token keyword">catch</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token comment">// catch方法</span>
  <span class="token function">finally</span><span class="token punctuation">(</span>onFinally<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token comment">// finally方法</span>

  <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token comment">// resolve静态方法</span>
  <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token comment">// reject静态方法</span>
  <span class="token keyword">static</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token comment">// all静态方法</span>
  <span class="token keyword">static</span> <span class="token function">race</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token comment">// race静态方法</span>
  <span class="token keyword">static</span> <span class="token function">any</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token comment">// any静态方法</span>
  <span class="token keyword">static</span> <span class="token function">allSettled</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token comment">// allSettled静态方法</span>
  <span class="token keyword">static</span> <span class="token function">withResolvers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token comment">// withResolvers静态方法</span>
<span class="token punctuation">}</span>

<span class="token comment">// Promise解析函数</span>
<span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// 判断是否为函数的辅助函数</span>
<span class="token keyword">function</span> <span class="token function">isFunction</span><span class="token punctuation">(</span><span class="token parameter">o</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> o <span class="token operator">===</span> <span class="token string">'function'</span>
<span class="token punctuation">}</span> 

<span class="token comment">// 异步任务函数的辅助函数</span>
<span class="token keyword">function</span> <span class="token function">runTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h3 id="_2-构造函数constructor-executor"><a href="#_2-构造函数constructor-executor" class="header-anchor">#</a> 2. 构造函数<code>constructor(executor)</code></h3> <p>参照<code>ECMAScript Promise</code>规范对构造函数的定义，实现构造函数还是相对比较简单的，代码如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 必须使用new调用</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token punctuation">.</span>target <span class="token operator">!==</span> Promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Promise constructor cannot be invoked without new operator'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// executor必须为函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> executor <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Promise resolver </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>executor<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not a function</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'pending'</span> <span class="token comment">// 初始状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token comment">// 兑现终值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token comment">// 拒绝原因</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 存储成功回调</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 存储失败回调</span>

    <span class="token comment">// resolve和reject函数</span>
    <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 同步执行executor</span>
      <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> 
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token comment">// executor执行异常中断，promise需要被reject</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h3 id="_3-resolve和reject函数"><a href="#_3-resolve和reject函数" class="header-anchor">#</a> 3. resolve和reject函数</h3> <blockquote><p>以下<code>runTask</code>是一个执行异步任务的函数，在后文定义</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// resolve函数</span>
<span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果value是promise，则需要等待promise执行完成，再执行then</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// resolve回调必须是异步调用的</span>
  <span class="token function">runTask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 状态只能改变一次</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value <span class="token comment">// 设置终值</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'fulfilled'</span> <span class="token comment">// 状态标记为fulfilled</span>
    <span class="token comment">// 遍历fulfilled回调队列，以当前终值为参数按顺序调用所有的兑现回调函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// reject函数</span>
<span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">runTask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">!==</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// 状态只能改变一次</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason <span class="token comment">// 设置拒绝原因</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'rejected'</span> <span class="token comment">// 状态标记为rejected</span>
    <span class="token comment">// 遍历rejected回调队列，以当前拒因为参数按顺序调用所有的拒绝回调函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p><code>resolve</code>和<code>reject</code>的核心实现是改变状态和保存兑现的值或者拒绝的原因，然后开启一个异步任务，将回调函数添加到回调队列中。同时应该保证，<code>Promise</code>的状态只能被改变一次。</p> <h3 id="_4-then实例方法"><a href="#_4-then实例方法" class="header-anchor">#</a> 4. then实例方法</h3> <p><code>then</code>方法是整个<code>Promise</code>的核心，只要<code>then</code>方法实现了，<code>Promise</code>上的各种常见的静态方法都可以基于它来实现。<code>then</code>方法接收两个参数，第一个参数是<code>onFulfilled</code>，表示兑现后要执行的回调函数，第二个参数是<code>onRejected</code>，表示拒绝后要执行的回调函数。我们参照规范，逐步来实现<code>then</code>方法。</p> <p><strong><code>then(onFulfilled, onRejected)</code>：</strong></p> <p>首先，then方法必须返回一个新的<code>Promise</code>实例。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> newPromise
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>其次，then方法必须接受两个参数，<code>onFulfilled</code>和<code>onRejected</code>。它们都是可选的，如果不传入函数则忽略</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  onFulfilled <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span> <span class="token operator">?</span> onFulfilled <span class="token operator">:</span> <span class="token keyword">undefined</span>
  onRejected <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span> <span class="token operator">?</span> onRejected <span class="token operator">:</span> <span class="token keyword">undefined</span>

  <span class="token keyword">const</span> newPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> newPromise
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>接着就是<code>onFulfilled</code>和 <code>onRejected</code>的处理程序了。规范要求，如果<code>promise</code>处于<code>pending</code>状态，那么<code>onFulfilled</code>和<code>onRejected</code>必须被添加到<code>promise</code>的<code>onFulfilledCallbacks</code>和<code>onRejectedCallbacks</code>数组中。同时同一个<code>promise</code>的<code>then</code>方法是可以被多次调用的，它们应该被按顺序添加到对应的数组中。如果<code>promise</code>的状态已经改变，那么<code>onFulfilled</code>或<code>onRejected</code>应该被执行。因此，<code>then</code>方法中的新Promise的执行主体应该包含三种情况来处理。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> newPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 存储回调</span>
    <span class="token keyword">return</span> 
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token comment">// 执行兑现回调</span>
    <span class="token keyword">return</span> 
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
    <span class="token comment">// 执行拒绝回调</span>
    <span class="token keyword">return</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>然后根据<code>then</code>函数处理<code>onFulfilled</code>和 <code>onRejected</code>的以下几点要求，我们继续完善代码：</p> <ul><li><code>onFulfilled</code>和 <code>onRejected</code>是异步执行的，所以需要将<code>onFulfilled</code>和 <code>onRejected</code>函数放入异步任务队列中执行。</li> <li><code>onFulfilled</code>和<code>onRejected</code>必须被作为普通函数调用</li> <li>如果<code>onFulfilled</code>或<code>onRejected</code>返回一个值<code>x</code>时，调用<code>resolvePromise</code>函数进行解析；否则如果它们抛出异常，则新的Promise需要被拒绝。</li> <li>如果<code>onFulfilled</code>或<code>onRejected</code>不是函数，且<code>promise</code>的状态已经改变，那么<code>then</code>方法返回的新Promise的状态应该和原Promise一样（也叫<code>回调穿透</code>）</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 用于执行回调的辅助函数</span>
<span class="token keyword">function</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//  onFulfilled或onRejected执行抛出异常需要将新Promise拒绝</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// fulfilled状态直接执行兑现回调</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">runTask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 回调需要异步调用</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 返回了一个值，则进入resolvePromise解析流程</span>
      <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
      <span class="token function">resolvePromise</span><span class="token punctuation">(</span>newPromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token comment">// rejected状态直接执行拒绝回调</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 与fulfilled状态处理同理</span>
  <span class="token function">runTask</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
      <span class="token function">resolvePromise</span><span class="token punctuation">(</span>newPromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果是pending状态，则将回调函数添加到回调队列中</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 此处存储的回调最终会被resolve或者reject遍历执行，已经是异步执行的了</span>
  <span class="token comment">// 因此此处只要保证把执行异常捕获了就可以</span>
  onFulfilled <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
      <span class="token function">resolvePromise</span><span class="token punctuation">(</span>newPromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  onRejected <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
      <span class="token function">resolvePromise</span><span class="token punctuation">(</span>newPromise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>以上是<code>then</code>方法的核心实现，但是上面标准中的提到的<code>回调穿透</code>并没有实现。<code>回调穿透</code>指的是当上一个<code>promise</code>返回的终值或错误在下一个<code>then</code>回调中没有被处理时，那么下一个<code>then</code>回调中的<code>onFulfilled</code>或<code>onRejected</code>回调会被执行，直到末端。如果未被捕获，则会抛出一个<code>UnhandledPromiseRejectionWarning</code>警告（此处的警告不是规范的内容，但是常见的宿主环境在实现时都会做此处理）。目前为止，如下代码不能按照规范如期执行：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token comment">// 不会接收到'success'</span>

<span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'fail'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 不会打印err</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这是因为，第一个<code>then</code>返回的已经是一个新的<code>Promise</code>实例，后续的<code>then</code>和<code>catch</code>都会被添加到这个实例上，而不是<code>p</code>上。由于第一个<code>then</code>没有对<code>p</code>状态改变后的值进行传递，所以后续的<code>then</code>和<code>catch</code>都不会被执行。要解决此问题，只需要在<code>onFulfilled</code>和<code>onRejected</code>中不为函数的时候，将其重置为一个仅返回当前终值或者抛出当前异常的函数即可。将以下两处代码做如下修改：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">-</span> onFulfilled <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span> <span class="token operator">?</span> onFulfilled <span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token comment">// [!code --]</span>
  <span class="token operator">-</span> onRejected <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span> <span class="token operator">?</span> onRejected <span class="token operator">:</span> <span class="token keyword">undefined</span> <span class="token comment">// [!code --]</span>
  onFulfilled <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value <span class="token comment">// [!code ++]</span>
  onRejected <span class="token operator">=</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function-variable function">onRejected</span> <span class="token operator">:</span> <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> reason <span class="token punctuation">}</span> <span class="token comment">// [!code ++]</span>

  <span class="token keyword">const</span> newPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    onFulfilled <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// [!code --]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// [!code ++]</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    onRejected <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// [!code --]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// [!code ++]</span>
      <span class="token comment">//...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> newPromise
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h3 id="_5-resolvepromise"><a href="#_5-resolvepromise" class="header-anchor">#</a> 5. <code>resolvePromise</code></h3> <p><code>resolvePromise</code>是解析<code>then</code>方法中返回的值的核心方法，其也是保证<code>Promise</code>链式调用的关键，也是保证不同实现的<code>thenable</code>对象之间能够相互操作的关键。接下来，我们就照着<code>Promise/A+</code>的规范来实现<code>resolvePromise</code>函数。</p> <blockquote><p>我们把一个<code>promise</code>记为<code>promise1</code>，其<code>then</code>方法返回的新的<code>promise</code>记为<code>promise2</code>。</p></blockquote> <p><strong><code>resolvePromise(promise, x, resolve, reject)</code>：</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * @param {Promise} promise promise1.then返回的promise2
 * @param {any} x promise1的onFulfilled或onRejected的返回值
 * @param {Function} resolve promise2的resolve
 * @param {Function} reject promise2的reject
 */</span>
<span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 如果promise和x指向同一个对象，以TypeError为据因拒绝执行promise，防止循环引用</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Chaining cycle detected for promise'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token comment">// 处理thenable时，确保resolve和reject只被调用一次</span>

  <span class="token comment">// 2. 如果x是一个promise，则让promise接受x的状态</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2.1 如果x处于pending状态，promise必须保持pending状态，直到x被fulfilled或rejected</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
        <span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> value<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
      <span class="token comment">// 2.2 如果x处于fulfilled或rejected状态，则用相同的value执行promise</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> x <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 3. 如果x是一个对象或函数</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then <span class="token comment">// 读取其then属性</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>then<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 3.1 x上具有then方法（thenable对象）</span>
        <span class="token comment">// 3.1.1 将x作为this绑定，执行then方法</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
          x<span class="token punctuation">,</span>
          <span class="token parameter">y</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// resolve只能被执行一次</span>
            called <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// reject只能被执行一次</span>
            called <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
        <span class="token comment">// 3.2 x上没有then方法（普通对象），以其值兑现</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
      <span class="token comment">// 检索x.then失败，则需要拒绝promise2</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>
      called <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 4. 如果x是一个原始值</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>可以看到<code>resolvePromise</code>的实现还是比较复杂的，要彻底的理解<code>Promise</code>的运行机制，就必须要理解<code>resolvePromise</code>的实现，你可以多阅读几次该函数，好好理解和梳理其中的细节。</p> <h3 id="_6-runtask辅助函数"><a href="#_6-runtask辅助函数" class="header-anchor">#</a> 6. runTask辅助函数</h3> <p><code>Promise/A+</code>要求<code>resolve</code>、<code>reject</code>和<code>then</code>方法都是异步执行的，所以我们需要将<code>resolve</code>和<code>reject</code>方法封装成一个<code>runTask</code>函数。实现的方式可以使用宏任务，也可以使用微任务：</p> <ul><li><code>setTimeout</code>：宏任务</li> <li><code>setImmediate</code>：宏任务</li> <li><code>process.nextTick</code>：微任务</li> <li><code>MutationObserver</code>：微任务</li> <li>...</li></ul> <p>这里我们使用<code>setTimeout</code>来实现该异步任务函数</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">runTask</span><span class="token punctuation">(</span><span class="token parameter">task</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>到这里为止，其实<code>Promise/A+</code>规范的内容就已经全部实现完了，如果用这个实现去跑一下<code>Promise/A+</code>社区的测试用例，应该就可以全部通过啦。至于<code>Promise</code>其它的实例方法和静态方法，你可以简单的理解为它们大部分是<code>then</code>的语法糖或多个<code>Promise</code>实例的组合方法。下面我们就来实现这些方法。</p> <h3 id="_7-catch与finally实例方法"><a href="#_7-catch与finally实例方法" class="header-anchor">#</a> 7. <code>catch</code>与<code>finally</code>实例方法</h3> <p><strong>（1）<code>catch</code>实例方法：</strong></p> <p><code>catch</code>方法的实现非常简单，只需要将<code>onRejected</code>作为<code>then</code>的第二个参数传入即可。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">catch</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>（2）<code>finally</code>方法：</strong></p> <p><code>finally</code>方法是只要<code>Promise</code>完成（无论成功或失败）都会执行的操作，因此你可能会想到这么实现：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">finally</span><span class="token punctuation">(</span>onFinally<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFinally<span class="token punctuation">,</span> onFinally<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>但其实<code>finally</code>的实现是有要求的，它应该满足以下特点：</p> <ul><li><code>finally</code>方法必须返回一个<code>Promise</code>实例</li> <li><code>finally</code>方法无论<code>Promise</code>的状态如何，都会执行</li> <li><code>finally</code>方法返回值会被忽略</li> <li><code>finally</code>方法的回调函数不收任何参数</li> <li><code>finally``Promise</code>实例的结果会被传递至下一个<code>then</code>链</li></ul> <p>如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
     <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>   
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;finally&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">456</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;then2&quot;</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 输出 </span>
<span class="token comment">// finally undefined</span>
<span class="token comment">// then2 123</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>因此，我们可以将<code>onFinally</code>使用<code>Promise.resolve</code>包裹后来实现以上特点（你可以先阅读<code>Promise.resolve</code>的实现再回来看这里）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">finally</span><span class="token punctuation">(</span>onFinally<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
    <span class="token parameter">value</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">onFinally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token parameter">reason</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">onFinally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> reason <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_8-各种静态方法"><a href="#_8-各种静态方法" class="header-anchor">#</a> 8. 各种静态方法</h3> <p>ECMAScript 6中提供了<code>all</code>、<code>allSettled</code>、<code>race</code>、<code>any</code>四个组合静态方法以及<code>resolve</code>、<code>reject</code>、<code>withResolves</code>等几个静态方法。</p> <p><strong>（1）<code>Promise.all</code>方法</strong></p> <p><code>Promise.all()</code> 静态方法接受一个 Promise 可迭代对象作为输入，并返回一个 Promise。当所有输入的 Promise 都被兑现时，返回的 Promise 也将被兑现（即使传入的是一个空的可迭代对象），并返回一个包含所有兑现值的数组。如果输入的任何 Promise 被拒绝，则返回的 Promise 将被拒绝，并带有第一个被拒绝的原因。</p> <p>实现的基本思路是遍历传入的Promise迭代对象，并记录每个对象的执行结果，当所有Promise都被兑现时，将结果数组作为参数调用<code>resolve</code>方法。只要有一个Promise被拒绝，则将拒绝原因作为参数调用<code>reject</code>方法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// 存储结果</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 记录当前兑现的个数</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> p <span class="token operator">=</span> promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        count<span class="token operator">++</span>
        result<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> value
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">===</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 已全部兑现</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>（2）<code>Promise.allSettled</code>方法</strong></p> <p><code>Promise.allSettled()</code>静态方法将一个 Promise 可迭代对象作为输入，并返回一个单独的 Promise。当所有输入的 Promise 都已敲定（无论拒绝还是兑现）时（包括传入空的可迭代对象时），返回的 Promise 将被兑现，并带有描述每个 Promise 结果的对象数组。</p> <p>实现的基本思路是遍历传入的Promise迭代对象，并记录每个对象的执行结果（每一项为一个包含<code>{status, value | reason}</code>的对象），当所有Promise都被敲定时，将结果数组作为参数调用<code>resolve</code>方法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token function">allSettled</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">//结果</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">// 当前敲定个数</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> p <span class="token operator">=</span> promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        results<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">'fulfilled'</span><span class="token punctuation">,</span> value <span class="token punctuation">}</span> <span class="token comment">// 记录兑现结果</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        results<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token string">'rejected'</span><span class="token punctuation">,</span> reason <span class="token punctuation">}</span> <span class="token comment">// 记录拒绝原因</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        count<span class="token operator">++</span>
        <span class="token comment">// 已全部敲定</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">===</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>（3）<code>Promise.race</code>方法</strong></p> <p><code>Promise.race()</code>静态方法接受一个 promise 可迭代对象作为输入，并返回一个 Promise。这个返回的 promise 会随着第一个 promise 的敲定而敲定。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token function">race</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> p <span class="token operator">=</span> promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>（4）<code>Promise.any</code>方法</strong></p> <p><code>Promise.any()</code>静态方法将一个 Promise 可迭代对象作为输入，并返回一个 Promise。当输入的任何一个 Promise 兑现时，这个返回的 Promise 将会兑现，并返回第一个兑现的值。当所有输入 Promise 都被拒绝（包括传递了空的可迭代对象）时，它会以一个包含拒绝原因数组的 AggregateError 拒绝。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token function">any</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> p <span class="token operator">=</span> promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">reason</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        count<span class="token operator">++</span>
        errors<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> reason
        <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">===</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'none resolved'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AggregateError</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><strong>（5）<code>Promise.resolve</code>方法</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>  <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果value本身是promise则直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value
    <span class="token comment">// 之所以返回then创建的新promise，是为了让Promise.resolve(thenable)能够正常工作</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><strong>（6）<code>Promise.reject</code>方法</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>（7）<code>Promise.withResolves</code>方法</strong></p> <p><code>Promise.withResolvers()</code> 静态方法返回一个对象，其包含一个新的 Promise 对象和两个函数，用于解决或拒绝它，对应于传入给 Promise() 构造函数执行器的两个参数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token function">withResolvers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> resolve<span class="token punctuation">,</span> reject
  <span class="token keyword">const</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">_resolve<span class="token punctuation">,</span> _reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    resolve <span class="token operator">=</span> _resolve
    reject <span class="token operator">=</span> _reject
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    promise<span class="token punctuation">,</span>
    resolve<span class="token punctuation">,</span>
    reject
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="五、测试"><a href="#五、测试" class="header-anchor">#</a> 五、测试</h2> <p><code>Promise</code>测试通常是借助<a href="https://github.com/promises-aplus/promises-tests" target="_blank" rel="noopener noreferrer"><code>promises-aplus-tests</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>这个测试工具。其覆盖了完整的<code>Promise/A+</code>规范的测试用例，测试通过率达到100%才算完整实现了<code>Promise/A+</code>规范。</p> <p>首先安装测试工具：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">npm</span> i <span class="token parameter variable">-g</span> promises-aplus-tests

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后是添加一个适配器：测试工具要求实现的Promise库暴漏一个包含以下三个的API：</p> <ul><li><code>resolve(value)</code>（可选）：创建一个resolved的Promise</li> <li><code>reject(reason)</code>（可选）：创建一个rejected的Promise</li> <li><code>deferred()</code>：创建一个延迟对象，并返回一个对象，包含<code>promise</code>和<code>resolve</code>、<code>reject</code>方法</li></ul> <p>其中<code>resolve(value)</code>和<code>reject(reason)</code>已经实现了，如果没有提供，则测试工具会使用<code>deferred</code>对象自动创建。而<code>deferred</code>其实就是<code>Promise.withResolvers</code>方法，也可以使用以下方式再添加：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function-variable function">deferred</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 延迟对象</span>
  <span class="token keyword">let</span> defer <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  defer<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    defer<span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
    defer<span class="token punctuation">.</span>reject <span class="token operator">=</span> reject<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> defer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">提示</p> <p>jQuery的异步操作也是借助其<code>Deferred</code>对象实现的。</p></div> <p>把Promise导出</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Promise
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>最后执行测试：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>promises-aplus-tests promise.js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>测试结果是全部通过的，如下：</p> <p><img src="/images/promise-test-result.png" alt="promise-test-result"></p> <p>至此，我们已经把Promise/A+规范以及ECMAScript Promises所有的静态方法都实现了。完整的代码<a href="https://gitee.com/prianyu/demos/blob/master/promise.js" target="_blank" rel="noopener noreferrer">请点击这里查看<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">最近更新:</span> <span class="time">2024/06/19, 17:54</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/b call-apply-bind/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">call、apply和bind实现</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/b call-apply-bind/" class="prev">call、apply和bind实现</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/e0a820/"><div>
            Axios源码解读
            <!----></div></a> <span class="date">07-29</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/4c042c/"><div>
            基于React16的Webpack升级与构建速度优化
            <!----></div></a> <span class="date">07-09</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/a60a54/"><div>
            Vue-Router源码解读
            <!----></div></a> <span class="date">07-09</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:prianyu@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/prianyu" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2024-2024
    <span>深海鱼 | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7229fa99.js" defer></script><script src="/assets/js/2.240321f5.js" defer></script><script src="/assets/js/48.232fa4df.js" defer></script>
  </body>
</html>
